<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Getting Started with dmft • dmft</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started with dmft">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dmft</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/tutorial.html">Tutorial</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/choxos/dmft/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Getting Started with dmft</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/choxos/dmft/blob/main/vignettes/tutorial.Rmd" class="external-link"><code>vignettes/tutorial.Rmd</code></a></small>
      <div class="d-none name"><code>tutorial.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The <strong>dmft</strong> package implements the Age-Spatial-Temporal
(AST) model for estimating and projecting dental caries burden
(DMFT/dmft indices) at subnational level. It uses a two-stage
approach:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Stage 1</strong>: A random intercept mixed-effects model via
<code>lme4</code> (or optionally Stan for the Bayesian backend).</li>
<li>
<strong>Stage 2</strong>: AST kernel smoothing of residuals across
space, time, and age dimensions using Kronecker-product weight
matrices.</li>
</ol>
<p>This tutorial walks through the full analysis pipeline using
synthetic (phantom) data.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install from GitHub</span></span>
<span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pak.html" class="external-link">pak</a></span><span class="op">(</span><span class="st">"choxos/dmft"</span><span class="op">)</span></span></code></pre></div>
<p>For the experimental Bayesian backend, also install cmdstanr:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"cmdstanr"</span>,</span>
<span>                  repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"https://stan-dev.r-universe.dev"</span>, <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"repos"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">cmdstanr</span><span class="fu">::</span><span class="fu">install_cmdstan</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-1-configuration">Step 1: Configuration<a class="anchor" aria-label="anchor" href="#step-1-configuration"></a>
</h2>
<p>Every analysis begins with <code><a href="../reference/dmft_config.html">dmft_config()</a></code>, which defines
the regions, time period, age groups, and model parameters.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/choxos/dmft" class="external-link">dmft</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_config.html">dmft_config</a></span><span class="op">(</span></span>
<span>  regions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Region_A"</span>, <span class="st">"Region_B"</span>, <span class="st">"Region_C"</span>,</span>
<span>              <span class="st">"Region_D"</span>, <span class="st">"Region_E"</span><span class="op">)</span>,</span>
<span>  region_col <span class="op">=</span> <span class="st">"province"</span>,</span>
<span>  year_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">2020</span><span class="op">)</span>,</span>
<span>  projection_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2021</span>, <span class="fl">2030</span><span class="op">)</span>,</span>
<span>  age_groups_deciduous <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"0-4"</span>, <span class="st">"5-9"</span>, <span class="st">"10-14"</span><span class="op">)</span>,</span>
<span>  age_groups_permanent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"5-9"</span>, <span class="st">"10-14"</span>, <span class="st">"15-19"</span>, <span class="st">"20-24"</span>,</span>
<span>                           <span class="st">"25-29"</span>, <span class="st">"30-34"</span>, <span class="st">"35-39"</span>, <span class="st">"40-44"</span>,</span>
<span>                           <span class="st">"45-49"</span>, <span class="st">"50-54"</span>, <span class="st">"55-59"</span>, <span class="st">"60+"</span><span class="op">)</span>,</span>
<span>  ast_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    par_space <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>    par_time <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    par_age <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    weight_coverage <span class="op">=</span> <span class="fl">0.9</span></span>
<span>  <span class="op">)</span>,</span>
<span>  n_boot <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">42</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfg</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> DMFT analysis configuration</span></span>
<span><span class="co">#&gt;   Regions:      5 (Region_A, Region_B, Region_C, ...)</span></span>
<span><span class="co">#&gt;   Historical:   2000-2020 (21 years)</span></span>
<span><span class="co">#&gt;   Projections:  2021-2030</span></span>
<span><span class="co">#&gt;   Age groups:   deciduous=3, permanent=12</span></span>
<span><span class="co">#&gt;   AST params:   space=0.9, time=2, age=1</span></span>
<span><span class="co">#&gt;   Covariates:   none</span></span>
<span><span class="co">#&gt;   Bootstrap:    200 replicates</span></span>
<span><span class="co">#&gt;   Seed:         42</span></span></code></pre></div>
<p>Key parameters:</p>
<ul>
<li>
<strong><code>regions</code></strong>: Character vector of
subnational region names. These must match your data and shapefile.</li>
<li>
<strong><code>region_col</code></strong>: The column name in your
data containing region names.</li>
<li>
<strong><code>year_range</code></strong>: Historical period
<code>c(start, end)</code>.</li>
<li>
<strong><code>projection_range</code></strong>: Future projection
period (optional).</li>
<li>
<strong><code>ast_params</code></strong>: Smoothing parameters for
the AST kernel (see Model Details below).</li>
<li>
<strong><code>n_boot</code></strong>: Number of bootstrap replicates
for uncertainty intervals.</li>
<li>
<strong><code>covariates</code></strong>: Optional fixed-effect
covariates (column names in your data).</li>
</ul>
</div>
<div class="section level2">
<h2 id="step-2-generate-phantom-data">Step 2: Generate Phantom Data<a class="anchor" aria-label="anchor" href="#step-2-generate-phantom-data"></a>
</h2>
<p>For demonstration, we generate synthetic data. In practice, you would
load your own CSV/XLSX with <code><a href="../reference/dmft_load.html">dmft_load()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phantom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_phantom.html">dmft_phantom</a></span><span class="op">(</span><span class="va">cfg</span>, dentition <span class="op">=</span> <span class="st">"permanent"</span>, n_per_cell <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Generated 2142 phantom records</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">phantom</span><span class="op">)</span></span>
<span><span class="co">#&gt;                         study province year age_start age_end    sex   n</span></span>
<span><span class="co">#&gt; 1   phantom_Region_A_2000_5-9 Region_A 2000         5       9 Female  73</span></span>
<span><span class="co">#&gt; 2   phantom_Region_A_2000_5-9 Region_A 2000         5       9   Male  69</span></span>
<span><span class="co">#&gt; 3 phantom_Region_A_2000_10-14 Region_A 2000        10      14   Male 332</span></span>
<span><span class="co">#&gt; 4 phantom_Region_A_2000_10-14 Region_A 2000        10      14 Female 261</span></span>
<span><span class="co">#&gt; 5 phantom_Region_A_2000_20-24 Region_A 2000        20      24 Female  73</span></span>
<span><span class="co">#&gt; 6 phantom_Region_A_2000_20-24 Region_A 2000        20      24   Male 185</span></span>
<span><span class="co">#&gt;   mean_DMFT sd_DMFT</span></span>
<span><span class="co">#&gt; 1      1.50    0.98</span></span>
<span><span class="co">#&gt; 2      0.58    1.26</span></span>
<span><span class="co">#&gt; 3      3.03    1.95</span></span>
<span><span class="co">#&gt; 4      3.44    1.69</span></span>
<span><span class="co">#&gt; 5      8.25    2.55</span></span>
<span><span class="co">#&gt; 6      9.49    2.83</span></span></code></pre></div>
<p>The phantom data mimics realistic study-level data with known
age-by-region patterns, a temporal trend, and random missingness.</p>
<div class="section level3">
<h3 id="loading-your-own-data">Loading Your Own Data<a class="anchor" aria-label="anchor" href="#loading-your-own-data"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># From CSV</span></span>
<span><span class="va">raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_load.html">dmft_load</a></span><span class="op">(</span><span class="st">"path/to/your_data.csv"</span>, config <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># From Excel</span></span>
<span><span class="va">raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_load.html">dmft_load</a></span><span class="op">(</span><span class="st">"path/to/your_data.xlsx"</span>, config <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span></code></pre></div>
<p>Your data should have at minimum:</p>
<table class="table">
<colgroup>
<col width="38%">
<col width="61%">
</colgroup>
<thead><tr class="header">
<th>Column</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Region column (matching <code>region_col</code>)</td>
<td>Region name</td>
</tr>
<tr class="even">
<td><code>year</code></td>
<td>Year of data collection</td>
</tr>
<tr class="odd">
<td><code>age_start</code></td>
<td>Start of age range</td>
</tr>
<tr class="even">
<td><code>age_end</code></td>
<td>End of age range</td>
</tr>
<tr class="odd">
<td>
<code>mean_dmft</code> and/or <code>mean_DMFT</code>
</td>
<td>Mean dmft (deciduous) / DMFT (permanent)</td>
</tr>
<tr class="even">
<td><code>n</code></td>
<td>Sample size (optional, used for weighting)</td>
</tr>
<tr class="odd">
<td>
<code>sd_dmft</code> / <code>se_dmft</code>
</td>
<td>Standard deviation / error (optional, imputed if missing)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="step-3-data-cleaning">Step 3: Data Cleaning<a class="anchor" aria-label="anchor" href="#step-3-data-cleaning"></a>
</h2>
<p><code><a href="../reference/dmft_clean.html">dmft_clean()</a></code> performs column standardization, region
name mapping, age group assignment, outlier flagging, and uncertainty
imputation.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_clean.html">dmft_clean</a></span><span class="op">(</span><span class="va">phantom</span>, config <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Cleaned: 360 deciduous, 2142 permanent records</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">clean</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "deciduous" "permanent"</span></span></code></pre></div>
<p>The result is a list with <code>$deciduous</code> and
<code>$permanent</code> tibbles. Each has standardized columns including
<code>se_imputed</code> for inverse-variance weighting.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">clean</span><span class="op">$</span><span class="va">permanent</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"region_std"</span>, <span class="st">"year"</span>, <span class="st">"age_group"</span>, <span class="st">"mean_DMFT"</span>,</span>
<span>                         <span class="st">"se_imputed"</span>, <span class="st">"se_source"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; tibble [2,142 × 6] (S3: tbl_df/tbl/data.frame)</span></span>
<span><span class="co">#&gt;  $ region_std: chr [1:2142] "Region_A" "Region_A" "Region_A" "Region_A" ...</span></span>
<span><span class="co">#&gt;  $ year      : num [1:2142] 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 ...</span></span>
<span><span class="co">#&gt;  $ age_group : chr [1:2142] "5-9" "5-9" "10-14" "10-14" ...</span></span>
<span><span class="co">#&gt;  $ mean_DMFT : num [1:2142] 1.5 0.58 3.03 3.44 8.25 ...</span></span>
<span><span class="co">#&gt;  $ se_imputed: num [1:2142] 0.115 0.152 0.107 0.105 0.298 ...</span></span>
<span><span class="co">#&gt;  $ se_source : chr [1:2142] "from_sd_n" "from_sd_n" "from_sd_n" "from_sd_n" ...</span></span></code></pre></div>
<div class="section level3">
<h3 id="uncertainty-imputation">Uncertainty Imputation<a class="anchor" aria-label="anchor" href="#uncertainty-imputation"></a>
</h3>
<p>The package uses a hierarchical strategy to ensure every observation
has a standard error:</p>
<ol style="list-style-type: decimal">
<li>Use SE if reported directly</li>
<li>Compute SE from SD and sample size</li>
<li>Compute SE from confidence intervals</li>
<li>Estimate SD from a default coefficient of variation (CV), then
compute SE</li>
</ol>
<p>You can control the default CV via <code>cv_default</code> in
<code><a href="../reference/dmft_config.html">dmft_config()</a></code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="step-4-spatial-adjacency">Step 4: Spatial Adjacency<a class="anchor" aria-label="anchor" href="#step-4-spatial-adjacency"></a>
</h2>
<p><code><a href="../reference/dmft_adjacency.html">dmft_adjacency()</a></code> builds the neighbourhood graph from a
shapefile. Since we are using phantom data without a real shapefile, we
construct a simple adjacency manually:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For real data, use:</span></span>
<span><span class="co"># adj &lt;- dmft_adjacency(shapefile_path = "regions.shp", config = cfg)</span></span>
<span></span>
<span><span class="co"># For phantom data, create a mock adjacency</span></span>
<span><span class="va">adj_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">adj_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">adj_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">cfg</span><span class="op">$</span><span class="va">regions</span></span>
<span><span class="co"># Chain topology: A-B-C-D-E</span></span>
<span><span class="va">adj_matrix</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">adj_matrix</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">adj_matrix</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">adj_matrix</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">adj_matrix</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">adj_matrix</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">adj_matrix</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">adj_matrix</span><span class="op">[</span><span class="fl">5</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># Build spdep neighbourhood</span></span>
<span><span class="va">nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="va">nb</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">adj_matrix</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">nb</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"nb"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb</span>, <span class="st">"region.id"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">cfg</span><span class="op">$</span><span class="va">regions</span></span>
<span></span>
<span><span class="va">adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  adj_matrix   <span class="op">=</span> <span class="va">adj_matrix</span>,</span>
<span>  nb           <span class="op">=</span> <span class="va">nb</span>,</span>
<span>  sf           <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  location_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="va">cfg</span><span class="op">$</span><span class="va">regions</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>With real shapefiles, the function handles Queen contiguity, island
detection, and automatic region name matching.</p>
</div>
<div class="section level2">
<h2 id="step-5-model-fitting-frequentist">Step 5: Model Fitting (Frequentist)<a class="anchor" aria-label="anchor" href="#step-5-model-fitting-frequentist"></a>
</h2>
<p><code><a href="../reference/dmft_fit.html">dmft_fit()</a></code> runs Stage 1 of the AST methodology: a random
intercept mixed-effects model via <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lme4::lmer()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_fit.html">dmft_fit</a></span><span class="op">(</span></span>
<span>  data      <span class="op">=</span> <span class="va">clean</span><span class="op">$</span><span class="va">permanent</span>,</span>
<span>  adjacency <span class="op">=</span> <span class="va">adj</span>,</span>
<span>  dentition <span class="op">=</span> <span class="st">"permanent"</span>,</span>
<span>  config    <span class="op">=</span> <span class="va">cfg</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Model data: 2142 obs, 5 regions, years 2000-2020</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Fitting lme4 model (permanent): y ~ 1 + (1 | region_std) + (1 | year_factor)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> lme4 fit complete in 0.9s (AIC=14788.8, BIC=14811.4)</span></span></code></pre></div>
<p>The model formula is:</p>
<pre><code>y ~ 1 + [covariates] + (1|region_std) + (1|year_factor)</code></pre>
<p>with inverse-variance weights from <code>se_imputed</code>.</p>
<div class="section level3">
<h3 id="adding-covariates">Adding Covariates<a class="anchor" aria-label="anchor" href="#adding-covariates"></a>
</h3>
<p>To include fixed-effect covariates:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfg_cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_config.html">dmft_config</a></span><span class="op">(</span></span>
<span>  regions <span class="op">=</span> <span class="va">cfg</span><span class="op">$</span><span class="va">regions</span>,</span>
<span>  region_col <span class="op">=</span> <span class="st">"province"</span>,</span>
<span>  year_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">2020</span><span class="op">)</span>,</span>
<span>  covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fluoridation_pct"</span>, <span class="st">"sugar_consumption"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="step-6-predictions-with-ast-smoothing">Step 6: Predictions with AST Smoothing<a class="anchor" aria-label="anchor" href="#step-6-predictions-with-ast-smoothing"></a>
</h2>
<p><code><a href="../reference/dmft_predict.html">dmft_predict()</a></code> applies Stage 2 (AST kernel smoothing)
and computes bootstrap uncertainty intervals.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">estimates</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_predict.html">dmft_predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">adj</span>, config <span class="op">=</span> <span class="va">cfg</span>, n_boot <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Computing bootstrap uncertainty (100 replicates)...</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Predictions: 1260 cells (permanent)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">estimates</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 6</span></span></span>
<span><span class="co">#&gt;   region    year age_group predicted lower upper</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Region_A  <span style="text-decoration: underline;">2</span>000 10-14          3.47  1.38  5.55</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Region_A  <span style="text-decoration: underline;">2</span>000 15-19          5.34  1.47  5.73</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Region_A  <span style="text-decoration: underline;">2</span>000 20-24          7.29  2.00  5.52</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Region_A  <span style="text-decoration: underline;">2</span>000 25-29          9.32  1.62  5.53</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Region_A  <span style="text-decoration: underline;">2</span>000 30-34         11.3   1.95  5.83</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> Region_A  <span style="text-decoration: underline;">2</span>000 35-39         13.5   1.23  6.03</span></span></code></pre></div>
<p>The result is a tibble with one row per region-year-age_group
cell:</p>
<ul>
<li>
<code>predicted</code>: AST-smoothed point estimate</li>
<li>
<code>lower</code>, <code>upper</code>: 95% bootstrap confidence
intervals</li>
</ul>
<div class="section level3">
<h3 id="how-ast-smoothing-works">How AST Smoothing Works<a class="anchor" aria-label="anchor" href="#how-ast-smoothing-works"></a>
</h3>
<p>Residuals from Stage 1 are smoothed using three kernel weight
matrices:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Spatial</strong>: Adjacency-based weights with parameter
<code>par_space</code> (default 0.9). Self-weight is high; adjacent
regions get moderate weight; non-adjacent get zero.</li>
<li>
<strong>Temporal</strong>: LOESS-style cubic power weights with
parameter <code>par_time</code> (default 2). Nearby years get high
weight, distant years get low weight.</li>
<li>
<strong>Age</strong>: Exponential decay with parameter
<code>par_age</code> (default 1). Adjacent age groups get high weight,
distant groups get low weight.</li>
</ol>
<p>The combined weight matrix is the Kronecker product:
<code>W = kronecker(space_mat, kronecker(age_mat, time_mat))</code>,
row-normalized to sum to 1.</p>
</div>
</div>
<div class="section level2">
<h2 id="step-7-diagnostics">Step 7: Diagnostics<a class="anchor" aria-label="anchor" href="#step-7-diagnostics"></a>
</h2>
<p><code><a href="../reference/dmft_diagnose.html">dmft_diagnose()</a></code> computes fit statistics, residual
diagnostics, spatial autocorrelation tests, and prediction validity
checks.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diag</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_diagnose.html">dmft_diagnose</a></span><span class="op">(</span><span class="va">fit</span>, config <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in deviance.merMod(fit): deviance() is deprecated for REML fits; use</span></span>
<span><span class="co">#&gt; REMLcrit for the REML criterion or deviance(.,REML=FALSE) for deviance</span></span>
<span><span class="co">#&gt; calculated at the REML fit</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Diagnostics (PERMANENT)</span></span>
<span><span class="co">#&gt;   AIC=14788.8  BIC=14811.4</span></span>
<span><span class="co">#&gt;   RMSE=9.500  MAE=7.589  Bias=6.8087</span></span>
<span><span class="co">#&gt;   Var(year_factor): 0.1139 (SD=0.3374)</span></span>
<span><span class="co">#&gt;   Var(region_std): 0.0838 (SD=0.2894)</span></span>
<span><span class="co">#&gt;   Var(Residual): 0.8671 (SD=0.9312)</span></span>
<span><span class="co">#&gt;   Moran's I: stat=-1.1351, p=0.2563 (OK)</span></span>
<span><span class="co">#&gt;   Predictions: range [2.97, 4.34], 0&lt;0, 0&gt;28</span></span></code></pre></div>
<p>Key diagnostic outputs:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit statistics</span></span>
<span><span class="va">diag</span><span class="op">$</span><span class="va">fit_stats</span></span>
<span><span class="co">#&gt;     metric     value</span></span>
<span><span class="co">#&gt; 1      AIC 14788.758</span></span>
<span><span class="co">#&gt; 2      BIC 14811.436</span></span>
<span><span class="co">#&gt; 3   logLik -7390.379</span></span>
<span><span class="co">#&gt; 4 deviance 14780.758</span></span>
<span></span>
<span><span class="co"># Variance components</span></span>
<span><span class="va">diag</span><span class="op">$</span><span class="va">variance_components</span></span>
<span><span class="co">#&gt;         group   variance        sd</span></span>
<span><span class="co">#&gt; 1 year_factor 0.11386961 0.3374457</span></span>
<span><span class="co">#&gt; 2  region_std 0.08377718 0.2894429</span></span>
<span><span class="co">#&gt; 3    Residual 0.86708501 0.9311740</span></span>
<span></span>
<span><span class="co"># Residual metrics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"RMSE: %.3f\nMAE:  %.3f\nBias: %.4f\n"</span>,</span>
<span>            <span class="va">diag</span><span class="op">$</span><span class="va">residuals</span><span class="op">$</span><span class="va">rmse</span>, <span class="va">diag</span><span class="op">$</span><span class="va">residuals</span><span class="op">$</span><span class="va">mae</span>, <span class="va">diag</span><span class="op">$</span><span class="va">residuals</span><span class="op">$</span><span class="va">bias</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; RMSE: 9.500</span></span>
<span><span class="co">#&gt; MAE:  7.589</span></span>
<span><span class="co">#&gt; Bias: 6.8087</span></span>
<span></span>
<span><span class="co"># Spatial autocorrelation (Moran's I)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">diag</span><span class="op">$</span><span class="va">spatial</span><span class="op">$</span><span class="va">p.value</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Moran's I: %.4f (p = %.4f)\n"</span>,</span>
<span>              <span class="va">diag</span><span class="op">$</span><span class="va">spatial</span><span class="op">$</span><span class="va">statistic</span>, <span class="va">diag</span><span class="op">$</span><span class="va">spatial</span><span class="op">$</span><span class="va">p.value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Moran's I: -1.1351 (p = 0.2563)</span></span></code></pre></div>
<p>A non-significant Moran’s I (p &gt; 0.05) suggests the AST smoothing
has adequately captured spatial structure.</p>
</div>
<div class="section level2">
<h2 id="step-8-projections">Step 8: Projections<a class="anchor" aria-label="anchor" href="#step-8-projections"></a>
</h2>
<p><code><a href="../reference/dmft_project.html">dmft_project()</a></code> extrapolates temporal trends with three
scenarios:</p>
<ul>
<li>
<strong>Reference</strong>: continuation of the observed trend</li>
<li>
<strong>Optimistic</strong>: accelerated improvement (default:
-0.02/year adjustment)</li>
<li>
<strong>Pessimistic</strong>: slower improvement (default:
+0.02/year adjustment)</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">projections</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_project.html">dmft_project</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">estimates</span>, config <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Projected 10 years across 3 scenarios</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">projections</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">#&gt;    year scenario  mean_proj lower upper</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  <span style="text-decoration: underline;">2</span>021 Reference      3.46  1.63  5.29</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>  <span style="text-decoration: underline;">2</span>022 Reference      3.44  1.61  5.26</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  <span style="text-decoration: underline;">2</span>023 Reference      3.41  1.59  5.24</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>  <span style="text-decoration: underline;">2</span>024 Reference      3.39  1.57  5.22</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>  <span style="text-decoration: underline;">2</span>025 Reference      3.38  1.55  5.21</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>  <span style="text-decoration: underline;">2</span>026 Reference      3.36  1.53  5.19</span></span></code></pre></div>
<p>The trend is estimated from the last 10 years of year random effects,
with damping (default 0.95 per year) to prevent unrealistic
extrapolation.</p>
</div>
<div class="section level2">
<h2 id="step-9-visualization">Step 9: Visualization<a class="anchor" aria-label="anchor" href="#step-9-visualization"></a>
</h2>
<div class="section level3">
<h3 id="temporal-trends">Temporal Trends<a class="anchor" aria-label="anchor" href="#temporal-trends"></a>
</h3>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dmft_plot_trends.html">dmft_plot_trends</a></span><span class="op">(</span><span class="va">estimates</span>, <span class="va">projections</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-16-1.png" class="r-plt" alt="" width="768"></p>
</div>
<div class="section level3">
<h3 id="choropleth-maps">Choropleth Maps<a class="anchor" aria-label="anchor" href="#choropleth-maps"></a>
</h3>
<p>With a real shapefile:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dmft_plot_map.html">dmft_plot_map</a></span><span class="op">(</span><span class="va">estimates</span>, <span class="va">adj</span><span class="op">$</span><span class="va">sf</span>, year <span class="op">=</span> <span class="fl">2020</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="full-pipeline">Full Pipeline<a class="anchor" aria-label="anchor" href="#full-pipeline"></a>
</h2>
<p>For convenience, <code><a href="../reference/dmft_run.html">dmft_run()</a></code> orchestrates all steps in a
single call:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_run.html">dmft_run</a></span><span class="op">(</span></span>
<span>  data_path      <span class="op">=</span> <span class="st">"my_data.csv"</span>,</span>
<span>  shapefile_path <span class="op">=</span> <span class="st">"my_regions.shp"</span>,</span>
<span>  config         <span class="op">=</span> <span class="va">cfg</span>,</span>
<span>  dentition      <span class="op">=</span> <span class="st">"permanent"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Access results</span></span>
<span><span class="va">results</span><span class="op">$</span><span class="va">estimates</span><span class="op">$</span><span class="va">permanent</span></span>
<span><span class="va">results</span><span class="op">$</span><span class="va">diagnostics</span><span class="op">$</span><span class="va">permanent</span></span>
<span><span class="va">results</span><span class="op">$</span><span class="va">projections</span><span class="op">$</span><span class="va">permanent</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="bayesian-backend-experimental">Bayesian Backend (Experimental)<a class="anchor" aria-label="anchor" href="#bayesian-backend-experimental"></a>
</h2>
<p>The Bayesian backend uses Stan (via cmdstanr) for Stage 1 instead of
lme4. It provides posterior credible intervals instead of bootstrap
intervals.</p>
<div class="section level3">
<h3 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"cmdstanr"</span>,</span>
<span>                  repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"https://stan-dev.r-universe.dev"</span>, <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"repos"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">cmdstanr</span><span class="fu">::</span><span class="fu">install_cmdstan</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-by-step">Step-by-Step<a class="anchor" aria-label="anchor" href="#step-by-step"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit with Stan</span></span>
<span><span class="va">fit_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_fit_bayes.html">dmft_fit_bayes</a></span><span class="op">(</span></span>
<span>  data      <span class="op">=</span> <span class="va">clean</span><span class="op">$</span><span class="va">permanent</span>,</span>
<span>  adjacency <span class="op">=</span> <span class="va">adj</span>,</span>
<span>  dentition <span class="op">=</span> <span class="st">"permanent"</span>,</span>
<span>  config    <span class="op">=</span> <span class="va">cfg</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># AST smoothing + posterior credible intervals</span></span>
<span><span class="va">estimates_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_predict_bayes.html">dmft_predict_bayes</a></span><span class="op">(</span><span class="va">fit_b</span>, <span class="va">adj</span>, config <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bayesian diagnostics (Rhat, ESS, LOO-CV)</span></span>
<span><span class="va">diag_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_diagnose_bayes.html">dmft_diagnose_bayes</a></span><span class="op">(</span><span class="va">fit_b</span>, config <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Projections using posterior draws</span></span>
<span><span class="va">proj_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_project_bayes.html">dmft_project_bayes</a></span><span class="op">(</span><span class="va">fit_b</span>, <span class="va">estimates_b</span>, config <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="full-pipeline-bayesian">Full Pipeline (Bayesian)<a class="anchor" aria-label="anchor" href="#full-pipeline-bayesian"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_run.html">dmft_run</a></span><span class="op">(</span></span>
<span>  data_path      <span class="op">=</span> <span class="st">"my_data.csv"</span>,</span>
<span>  shapefile_path <span class="op">=</span> <span class="st">"my_regions.shp"</span>,</span>
<span>  config         <span class="op">=</span> <span class="va">cfg</span>,</span>
<span>  backend        <span class="op">=</span> <span class="st">"bayesian"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="custom-stan-settings">Custom Stan Settings<a class="anchor" aria-label="anchor" href="#custom-stan-settings"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfg_bayes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dmft_config.html">dmft_config</a></span><span class="op">(</span></span>
<span>  regions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Region_A"</span>, <span class="st">"Region_B"</span>, <span class="st">"Region_C"</span><span class="op">)</span>,</span>
<span>  region_col <span class="op">=</span> <span class="st">"province"</span>,</span>
<span>  year_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">2020</span><span class="op">)</span>,</span>
<span>  stan_settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    chains        <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    iter_warmup   <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    iter_sampling <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    adapt_delta   <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>    max_treedepth <span class="op">=</span> <span class="fl">12</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="bayesian-diagnostics">Bayesian Diagnostics<a class="anchor" aria-label="anchor" href="#bayesian-diagnostics"></a>
</h3>
<p>The Bayesian diagnostics include:</p>
<ul>
<li>
<strong>Rhat</strong>: Should be &lt; 1.01 for all parameters</li>
<li>
<strong>ESS</strong> (bulk and tail): Should be &gt; 400</li>
<li>
<strong>Divergences</strong>: Should be 0</li>
<li>
<strong>LOO-CV</strong>: Leave-one-out cross-validation via
<code>loo::loo()</code>
</li>
<li>
<strong>Posterior predictive checks</strong>: Coverage of observed
data by posterior predictive intervals</li>
<li>
<strong>Variance decomposition</strong>: From posterior draws of
sigma parameters</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="model-details">Model Details<a class="anchor" aria-label="anchor" href="#model-details"></a>
</h2>
<div class="section level3">
<h3 id="stage-1-mixed-effects-model">Stage 1: Mixed-Effects Model<a class="anchor" aria-label="anchor" href="#stage-1-mixed-effects-model"></a>
</h3>
<p>The model for observation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>∼</mo><mtext mathvariant="normal">Normal</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mi>i</mi></msub><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo>+</mo><msubsup><mtext mathvariant="normal">se</mtext><mi>i</mi><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">y_i \sim \text{Normal}(\mu_i, \sigma^2 + \text{se}_i^2)</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>i</mi></msub><mo>=</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>X</mi><mi>i</mi></msub><mi>β</mi><mo>+</mo><msub><mi>b</mi><mrow><mtext mathvariant="normal">region</mtext><mrow><mo stretchy="true" form="prefix">[</mo><mi>i</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub><mo>+</mo><msub><mi>b</mi><mrow><mtext mathvariant="normal">year</mtext><mrow><mo stretchy="true" form="prefix">[</mo><mi>i</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub></mrow><annotation encoding="application/x-tex">\mu_i = \beta_0 + X_i\beta + b_{\text{region}[i]} + b_{\text{year}[i]}</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mtext mathvariant="normal">region</mtext></msub><mo>∼</mo><mtext mathvariant="normal">Normal</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msubsup><mi>σ</mi><mtext mathvariant="normal">region</mtext><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">b_{\text{region}} \sim \text{Normal}(0, \sigma_{\text{region}}^2)</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mtext mathvariant="normal">year</mtext></msub><mo>∼</mo><mtext mathvariant="normal">Normal</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msubsup><mi>σ</mi><mtext mathvariant="normal">year</mtext><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">b_{\text{year}} \sim \text{Normal}(0, \sigma_{\text{year}}^2)</annotation></semantics></math></p>
<p>Where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mtext mathvariant="normal">se</mtext><mi>i</mi></msub><annotation encoding="application/x-tex">\text{se}_i</annotation></semantics></math>
is the known (or imputed) standard error for each study, providing
inverse-variance weighting.</p>
</div>
<div class="section level3">
<h3 id="stage-2-ast-kernel-smoothing">Stage 2: AST Kernel Smoothing<a class="anchor" aria-label="anchor" href="#stage-2-ast-kernel-smoothing"></a>
</h3>
<p>Residuals
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>i</mi></msub><mo>=</mo><msub><mi>y</mi><mi>i</mi></msub><mo>−</mo><msub><mover><mi>y</mi><mo accent="true">̂</mo></mover><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">r_i = y_i - \hat{y}_i</annotation></semantics></math>
are smoothed using:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>r</mi><mo accent="true">̂</mo></mover><mrow><mi>a</mi><mo>,</mo><mi>t</mi><mo>,</mo><mi>s</mi></mrow></msub><mo>=</mo><munder><mo>∑</mo><mrow><mi>a</mi><mi>′</mi><mo>,</mo><mi>t</mi><mi>′</mi><mo>,</mo><mi>s</mi><mi>′</mi></mrow></munder><msub><mi>W</mi><mrow><mi>a</mi><mo>,</mo><mi>a</mi><mi>′</mi></mrow></msub><mo>⋅</mo><msub><mi>W</mi><mrow><mi>t</mi><mo>,</mo><mi>t</mi><mi>′</mi></mrow></msub><mo>⋅</mo><msub><mi>W</mi><mrow><mi>s</mi><mo>,</mo><mi>s</mi><mi>′</mi></mrow></msub><mo>⋅</mo><msub><mi>r</mi><mrow><mi>a</mi><mi>′</mi><mo>,</mo><mi>t</mi><mi>′</mi><mo>,</mo><mi>s</mi><mi>′</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\hat{r}_{a,t,s} = \sum_{a',t',s'} W_{a,a'} \cdot W_{t,t'} \cdot W_{s,s'} \cdot r_{a',t',s'}</annotation></semantics></math></p>
<p>where the weight matrices are:</p>
<ul>
<li>
<strong>Spatial</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>S</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>ρ</mi></mrow><annotation encoding="application/x-tex">W_S(i,j) = \rho</annotation></semantics></math>
if
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i=j</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>ρ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\rho(1-\rho)</annotation></semantics></math>
if adjacent, 0 otherwise</li>
<li>
<strong>Temporal</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>T</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mrow><mo stretchy="true" form="prefix">|</mo><mi>i</mi><mo>−</mo><mi>j</mi><mo stretchy="true" form="postfix">|</mo></mrow><mi>/</mi><mi>T</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>λ</mi></msup><mo stretchy="true" form="postfix">)</mo></mrow><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">W_T(i,j) = (1 - (|i-j|/T)^\lambda)^3</annotation></semantics></math>
(LOESS cubic power)</li>
<li>
<strong>Age</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>A</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mo>−</mo><mi>ω</mi><mrow><mo stretchy="true" form="prefix">|</mo><mi>i</mi><mo>−</mo><mi>j</mi><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">W_A(i,j) = \exp(-\omega|i-j|)</annotation></semantics></math>
(exponential decay)</li>
</ul>
<p>The combined weight matrix is:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>=</mo><msub><mi>W</mi><mi>S</mi></msub><mo>⊗</mo><msub><mi>W</mi><mi>A</mi></msub><mo>⊗</mo><msub><mi>W</mi><mi>T</mi></msub></mrow><annotation encoding="application/x-tex">W = W_S \otimes W_A \otimes W_T</annotation></semantics></math>
(Kronecker product), row-normalized.</p>
<p>Final estimates:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>y</mi><mo accent="true">̂</mo></mover><mrow><mi>a</mi><mo>,</mo><mi>t</mi><mo>,</mo><mi>s</mi></mrow></msub><mo>=</mo><msub><mover><mi>μ</mi><mo accent="true">̂</mo></mover><mrow><mi>a</mi><mo>,</mo><mi>t</mi><mo>,</mo><mi>s</mi></mrow></msub><mo>+</mo><msub><mover><mi>r</mi><mo accent="true">̂</mo></mover><mrow><mi>a</mi><mo>,</mo><mi>t</mi><mo>,</mo><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\hat{y}_{a,t,s} = \hat{\mu}_{a,t,s} + \hat{r}_{a,t,s}</annotation></semantics></math></p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>Shoaee S, et al. (2022). Subnational estimation of dental caries
burden. <em>BMC Oral Health</em>, 22:634.</li>
<li>Shoaee S, et al. (2025). Subnational estimation using AST models.
<em>BMC Oral Health</em>, 25:1490.</li>
<li>Foreman KJ, et al. (2012). Modeling causes of death: an integrated
approach using CODEm. <em>Population Health Metrics</em>, 10:1.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ahmad Sofi-Mahmudi.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
